## 第一章 深入Web请求

### B/S架构

#### B/S架构的好处

1.  客户端使用统一的浏览器。浏览器具有统一性，屏蔽了服务器提供商提供给用户使用服务的差异性。用户使用它非常简便。
2.  服务端（Server）基于统一的HTTP。为服务提供商简化了开发模式。

#### 1.1 B/S网络架构概述

​	与大多数传统C/S互联网应用程序采用的长连接的交互方式不同，HTTP采用无状态的短连接的通信方式，一次请求就完成了一次数据交互，通常也对应一个业务逻辑，然后此次通信连接就断开了，采用此方式是为了服务更多的用户。

​	**当一个用户在浏览器输入一个URL时**：

- 首先它会请求DNS将域名解析成对应的IP地址
- 根据IP地址在互联网上找到对应的服务器，向服务器发起一个get请求，服务器返回默认的数据资源给访问的用户。
  - 服务器可能有多台，由哪台服务器处理请求，需要一个负载均衡设备来平均分配所有用户的请求
  - 请求的数据有可能存储在分布式缓存中、静态文件中或数据库里

- 当数据返回给浏览器时，浏览器解析数据发现还有一些静态资源（CSS、JS或者图片）时又会发起另外的HTTP请求，这些请求有可能会在CDN上，那么CDN服务器会处理这个用户的请求。、

  - CDN即内容分发网络，CDN的关键技术主要有内容存储和分发技术。

  **不管网络架构如何变化，始终有一些固定不变的原则需要遵守**

- 互联网上所有资源都要用一个URL来表示。即统一资源定位符。
- 必须基于HTTP与服务端交互。
- 数据展示必须在浏览器中进行。

#### 1.2 如何发起一个请求

​	建立一个HTTP请求就是建立一个Socket连接，只不过`outputStream.write`写的二进制字节数据格式要符合HTTP。

- 浏览器在建立Socket连接之前，根据输入的URL通过DNS解析出IP地址。
- 根据这个IP地址和默认的80端口与远程服务器建立Socket连接。
- 浏览器组装成一个get类型的HTTP请求头，通过`outputstream.write`发送到目标服务器，服务器等待`inputstream.read`返回数据

#### 1.3 HTTP解析

**表1-1		常见的HTTP请求头**

|     请求头      |                             说明                             |
| :-------------: | :----------------------------------------------------------: |
| Accept-Charset  |                  用于指定客户端接受的字符集                  |
| Accept-Encoding |   用于指定可接受内容编码：如Accept-Encoding：gzip.deflate    |
| Accept-Language |        用于指定一种自然语言，如Accept-Language:zh-cn         |
|      Host       | 用于指定被请求资源的Internet主机和端口号，如Host:www.taobao.com |
|   User-Agent    |       客户端将它的操作系统、浏览器和其他属性告诉服务器       |
|   Connection    |          当前连接是否保持，如Connection:Keep-Alive           |

**表1-2		常见的HTTP响应头**

|      响应头      |                             说明                             |
| :--------------: | :----------------------------------------------------------: |
|      Server      |        使用的服务器名称，如Server:Apache/1.3.6(Unix)         |
|   Content-Type   | 用来指明发送给接受者的实体正文的媒体类型，如Content-Type:text/html;charset=GBK |
| Content-Encoding | 与请求报头Accept-Encoding对应，告诉浏览器服务端采用的是什么压缩编码 |
| Content-Language |       描述了资源所用的自然语言，与Accept-Language对应        |
|  Content-Length  |    指明实体正文的长度，用以字节方式存储的十进制数字来表示    |
|    Keep-Alive    |       保持连接的时间，如:Keep-Alive:timeout=5,max=120        |

**表1-3		常见的HTTP状态码**

| 状态码 |                  说明                  |
| :----: | :------------------------------------: |
|  200   |             客户端请求成功             |
|  302   |  临时跳转，跳转的地址通过Location指定  |
|  400   | 客户端请求有语法错误，不能被服务器识别 |
|  403   |    服务器收到请求，但是拒绝提供服务    |
|  404   |            请求的资源不存在            |
|  500   |        服务器发生不可预期的错误        |

##### 1.3.1 查看HTTP信息的工具

​	在Firefox浏览器下，使用最多的是Firebug，还有HttpFox工具提供的信息更安全。

​	Chrome浏览器也有类似的工具，如Google自带的调试工具。

##### 1.3.2 浏览器缓存机制

​	在我们浏览页面时发现有异常，通常考虑的是不是浏览器做了缓存，所以按Ctrl + F5组合键重新请求一次这个页面，重新请求的页面肯定是最新的页面。原因如下：

- 使用组合键刷新页面，浏览器会直接向目标URL发送请求，而不会使用浏览器缓存的数据；

- 及时发送到服务端，也有可能访问到的是缓存的数据，比如，在我们的应用服务器的前端部署一个缓存服务器，如Varnish代理，那么Varnish也可能直接使用缓存数据

  

**通过在HTTP请求头中增加一些请求头，告诉服务端要获取最新的数据而不是缓存**

1.  Cache-Control/pragma

   这个HTTP Head字段用于指定所有缓存机制在整个请求/响应链中必须服从的指令，通过指定为no-cache来请求最新数据。

#### 1.4 DNS域名解析

##### 1.4.1 DNS域名解析过程

 	1. 浏览器检查缓存中有没有这个域名对应的解析过的IP地址，缓存中有，解析过程结束。
     - 浏览器缓存大小与时间均有限制，时间限制通过TTL属性来设置。
 	2. 浏览器缓存中没有，浏览器会查找操作系统缓存中是否有这个域名对应的DNS解析结果。	
     - 在操作系统中通过hosts文件来完成域名的解析。

3. 通过网络配置中“DNS服务器地址”这一项，将域名发送给LDNS即本地区的域名服务器，大约%80的域名解析到这里就已经完成了。
4. 如果LDNS仍然没有命中，就直接到Root Server域名服务器请求解析。
5. 根域名服务器返回给本地域名服务器一个所查询域的主域名服务器（gTLD Server）地址。
   - gTLD是国际顶级域名服务器，如.com、.cn、.org等
6.  LDNS再向上一步返回的gTLD服务器发送请求。

7. 接收请求的gTLD服务器查找并返回此域名对应的Name Server域名服务器的地址，这个Name Server通常就是注册的域名服务器，例如在某个域名提供商申请的域名，那么这个域名解析任务就由这个域名提供商的服务器来完成。
8. Name Server域名服务器会查询存储的域名和IP的映射关系表，在正常关系下根据域名得到目标IP记录，连同一个TTL值返回DNS Server域名服务器。
9. 返回该域名对应的IP和TTL值，LDNS会缓存这个域名和IP的对应关系，缓存的时间由TTL值控制。
10. 把解析结果返回给用户，用户根据TTL值缓存在本地系统缓存中，域名解析过程结束。

##### 1.4.2 跟踪域名解析过程

	- 在Linux和Windows下都可以用nslookup命令来查询域名的解析结果。
 - 在Linux系统中还可以使用dig命令来查询DNS的解析过程。
   - "QUESTION SECTION"部分表明当前查询的域名是一个A记录。
   - “ANSWER SECTION”部分返回了这个域名对应的IP地址。

- 还可通过增加+trace参数跟踪这个域名的解析过程。

##### 1.4.3 清除缓存的域名

​	**DNS域名解析后会缓存解析结果，其中主要在两个地方缓存结果**

	- 一个是Local DNS Server
	- 另外一个是用户的本地机器

这两个缓存都是TTL值和本机缓存大小控制的，最大缓存时间是TTL值，基本上LDNS的缓存时间就是TTL控制的，很难人工介入，但是我们的本机缓存可以通过如下方式消除：

- 在WIndows下可以在命令行模式下执行ipconfig/flushdns命令来刷新缓存
- 在Linux下可以通过/etc/init.d/nscd restart来清除缓存

##### 1.4.4 几种域名解析方式

- A记录，A代表的是Address，用来指定域名对应的IP地址。
- MX记录，
- CNAME记录
- NS记录
- TXT记录

#### 1.5 CDN工作机制

​	CDN也就是内容分布网络，其目的是使用户可以就近取得所需的内容，提高用户访问网站的响应速度。

​	目前CDN都以缓存网站中的静态数据为主，如CSS、JS、图片和静态页面等数据，用户在从主站服务器请求到动态内容后，再从CDN上下载这些静态数据，从而加速网页数据内容的下载速度。

##### 1.5.1 CDN架构

​	当一个用户访问某个静态文件时（如CSS文件），这个静态文件的域名假如是cdn.taobao.com

- 首先要向LDNS服务器发起请求，一般经过迭代解析后回到这个域名的注册服务器去解析。

- 一般每个公司都会有一个DNS解析服务器。DNS解析服务器通常会把它重新CNAME解析到另外一个域名，这个域名最终会被指向CDN全局中的DNS负载均衡服务器。

- 再由这个GTM来最终分配是哪个地方的访问用户，返回给离这个访问用户最近的CDN节点。

  拿到DNS解析结果，用户直接去这个CDN节点访问此静态文件，如果这个节点中所请求的文件不存在，就会再回到源站去获取此文件，然后再返回给用户。

##### 1.5.2 负载均衡

​	负载均衡（Load Balance）就是对工作任务进行平衡、分摊到多个操作单元上执行，如图片服务器、应用服务器等，共同完成工作任务。避免出现单点失效、网络拥塞等问题，实现地理位置无关性，为用户提供较一致的访问质量。

​	通常有三种负载均衡架构：

- 链路负载均衡
  - 通过DNS解析成不同的IP，然后用户根据这个来访问不同的目标服务器
    - 优点：用户直接访问目标服务器，不需要经过其他代理服务器，访问速度较快
    - 缺点：由于DNS在用户本地和LDNS都有缓存，一旦某台Web Server挂掉，很难及时更新用户的域名解析结构
- 集群负载均衡
  - 硬件负载均衡
    - 优点：性能非常好
    - 缺点：非常贵。当访问量陡然增大超出服务极限时，不能进行动态扩容
  - 软件负载均衡（使用最普遍）
    - 优点：使用成本非常低，直接使用廉价的PC就可以搭建。
    - 缺点：一次访问请求要经过多次代理服务器，增加网络延时。
- 操作系统负载均衡
  - 利用操作系统级别的软中断或者硬件中断来达到负载均衡，如可以设置多队列网卡来实现。

##### 1.5.3 CDN动态加速

​	CDN的动态加速技术也是当前比较流行的一种优化技术，其技术原理是在CDN的DNS解析中通过动态的链路探测来寻找回源最好的一条路径，然后通过DNS的调度将所有请求调度到选定的这条路径上回源，从而加速用户访问的效率。